import { initializeApp, getApps, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

const projectId = process.env.FIREBASE_PROJECT_ID;
const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;
const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n');

if (!projectId || !clientEmail || !privateKey) {
    // In development, if credentials aren't present, we might want to warn or mock
    if (process.env.NODE_ENV === 'production') {
        console.error('Missing Firebase credentials');
    }
}

const firebaseConfig = {
    projectId,
    credentials: cert({
        projectId,
        clientEmail,
        privateKey,
    }),
};

if (!getApps().length) {
    if (projectId && clientEmail && privateKey) {
        initializeApp(firebaseConfig);
    } else {
        // Fallback for build time or missing envs - prevents crash but won't work for real data
        console.warn("Firebase credentials missing, initializing minimal app for build safety or mock mode.");
        const mockConfig = { projectId: 'demo-project' }; // Dummy config
        initializeApp(mockConfig);
    }
}

export const db = getFirestore();
